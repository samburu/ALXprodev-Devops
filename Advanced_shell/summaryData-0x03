#!/usr/bin/env bash
set -euo pipefail

INPUT_DIR="pokemon_data"
OUTPUT_CSV="pokemon_report.csv"

# Check requirements
command -v jq >/dev/null 2>&1 || { echo "jq is required but not installed" >&2; exit 1; }
[ -d "$INPUT_DIR" ] || { echo "Directory '$INPUT_DIR' not found" >&2; exit 1; }

# Create CSV header
echo "Name,Height (m),Weight (kg)" > "$OUTPUT_CSV"

# Loop through all JSON files and extract data
for file in "$INPUT_DIR"/*.json; do
    name=$(jq -r '.name' "$file" | sed 's/.*/\u&/')
    height_dm=$(jq -r '.height' "$file")   # height in decimetres
    weight_hg=$(jq -r '.weight' "$file")   # weight in hectograms

    height_m=$(awk "BEGIN {printf \"%.1f\", $height_dm/10}")
    weight_kg=$(awk "BEGIN {printf \"%.1f\", $weight_hg/10}")

    echo "$name,$height_m,$weight_kg" >> "$OUTPUT_CSV"
done

echo "CSV Report generated at: $OUTPUT_CSV"
echo
cat "$OUTPUT_CSV"
echo

# Calculate averages using awk
awk -F, 'NR>1 {sum_h+=$2; sum_w+=$3; count++}
END {
    if (count>0) {
        printf "\nAverage Height: %.2f m\n", sum_h/count
        printf "Average Weight: %.2f kg\n", sum_w/count
    }
}' "$OUTPUT_CSV"
